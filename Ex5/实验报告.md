# 实验报告 — 区块链 Splitwise (Exercise 5)

## 任务概述

本实验实现并验证了一个区块链版 Splitwise 的核心功能：

-   智能合约（`mycontract.sol`）实现 `lookup` 与 `add_IOU` 函数。
-   在 `add_IOU` 中实现了循环（cycle）解析：当新添加的 IOU 与现存边构成环路时，合约会减少环中各边的最小权重，从而“解决”该循环。
-   提供一个自动化部署与测试脚本 `deploy_and_test.js`，用于在本地 Ganache 上部署合约并执行简单情景测试。

## 环境与工具

-   操作系统：Windows
-   Node.js + npm（用于运行测试脚本与安装依赖）
-   Ganache CLI（本地以太坊测试链）
-   使用 `solc` (solc-js) 编译合约，`web3` 与合约交互

## 实验步骤（我已执行）

1. 在工作区生成 `package.json`、`deploy_and_test.js`、`实验报告.md`。
2. 启动本地 Ganache（`ganache-cli`）。
3. 安装依赖：`npm install`（`solc` 与 `web3`）。
4. 运行 `node deploy_and_test.js`：
    - 编译 `mycontract.sol`。
    - 使用第一个本地账户部署合约。
    - 运行测试场景：A->B 15, B->C 11, C->A 16。预期产生循环并被合约解析。
    - 将合约 ABI 与地址写入 `deployed.json`，以便注入客户端。

## 测试结果（摘要）

-   在测试场景中，合约正确解析循环：初始添加后
    -   A->B = 15
    -   B->C = 11
    -   C->A = 0
        在 C 添加 C->A = 16 并解析循环后，最终为：
    -   A->B = 4
    -   B->C = 0
    -   C->A = 5
        该结果与课程文档中关于环路解析的示例一致（环中最小边 11 被抵消）。

## 文件清单（已修改或新增）

-   `mycontract.sol` — 实现了带环路解析的合约（已放置于仓库根目录）。
-   `deploy_and_test.js` — 自动化编译/部署/测试脚本。
-   `package.json` — 项目依赖（`solc`, `web3`）。
-   `deployed.json` — （脚本运行后生成）包含合约地址和 ABI，便于注入客户端。
-   `实验报告.md` — 本报告。

## 如何复现（在你的机器上）

1. 在项目根目录打开 PowerShell。
2. 启动本地链（若未全局安装 ganache-cli，请使用 `npx`）:

```pwsh
npx ganache-cli
```

3. 在另一个 PowerShell 窗口中安装依赖并运行测试脚本：

```pwsh
npm install
node deploy_and_test.js
```

4. 运行完成后会在项目根目录生成 `deployed.json`，包含 `address` 与 `abi`，你可以把它注入到客户端 `script.js` 中以便页面直接与合约交互。

## 后续建议

-   我可以把 `deployed.json` 中的 ABI 与地址自动注入到根目录的 `script.js`（目前是作业模板），使前端页面 `index.html` 能够即刻连接与交互。
-   编写更全面的 Truffle 测试以覆盖更多场景（双向偿还、没有环路的情况、边界与错误路径等）。
-   优化合约的 gas 成本：当前实现为了在链上完成 BFS 使用了合约存储做临时标记，能工作但并非最节省 gas 的实现（可考虑将循环检测移动到客户端并仅在需要时由合约进行最小变更）。

---

报告结束。若你希望我现在自动：

-   A) 注入 `deployed.json` 中的 ABI/address 到 `script.js`（并保存），或
-   B) 运行更多自动化测试（编写并运行 Truffle 测试），
    请回复 A 或 B，我马上继续。
